#!/usr/bin/perl

use Moo;
use strictures 2;
use 5.006;
use 5.22.1;
use version; our $VERSION = qv('0.1');
use namespace::clean;
use Daemon::Control;
use Getopt::Long;

# handle options

my ( $conf_dir, $delay ) = ( q{}, 300 );

Getopt::Long::GetOptions(
    'conf_dir|c' => \$conf_dir,
    'delay|d=i'  => \$delay,
);

my $args = [ '--delay', $delay ];
if ($conf_dir) { push @{$args}, '--conf_dir'; }

# run daemon

exit Daemon::Control->new(
    name         => 'Mail Directory Monitor',
    program      => '/usr/sbin/mail-dir-monitor',
    program_args => $args,
    path         => '/usr/sbin/mail-dir-launcher',
    pid_file     => '/var/run/mail-dir-monitor.pid',
    kill_timeout => 5,
    lsb_start    => '$syslog $local_fs $named $time',
    lsb_stop     => '$syslog $local_fs $named $time',
    lsb_sdesc    => 'A daemon which controls the mail-dir-monitor utility',
    lsb_desc     => 'Monitor mail queue directories for stuck files',
)->run;

# POD    {{{1
__END__

=encoding utf8

=head1 NAME

mail-dir-launcher - launcher for mail-dir-monitor daemon

=head1 USAGE

B<mail-dir-launcher> [B<-c>] [B<-d>] 

B<mail-dir-launcher> B<-h>

=head1 OPTIONS

=over

=item B<-c>  B<--conf_dir>

Display path to configuration directory and exit.

Boolean. Optional. Default: false.

=item B<-d>  B<--delay>

Delay in seconds between checking mail queue directories. Do not make this too
short or false errors may be generated by large emails which take a significant
amount of time to send.

Integer. Optional. Default: 300 (5 minutes).

=item B<-h>

Display help and exit.

=back

=head1 DESCRIPTION

Launch and daemonise the C<mail-dir-monitor> daemon which monitors mail queue
directories for unsent, or "stuck," email messages. See help for
C<mail-dir-monitor> for further information.

=head1 DEPENDENCIES

=head2 Executables

mail-dir-monitor.

=head2 Perl modules

Daemon::Control, Getopt::Long, Moo, namespace::clean, strictures, version.

=head1 BUGS AND LIMITATIONS

Please report any bugs to the author.

=head1 SEE ALSO

=over

=item mail-dir-monitor

The daemon process launched by this script.

=back

=head1 AUTHOR

David Nebauer (david at nebauer dot org)

=head1 LICENSE AND COPYRIGHT

Copyright (c) 2018 David Nebauer (david at nebauer dot org)

This script is free software; you can redistribute it and/or modify it under
the same terms as Perl itself.

=cut
# vim:foldmethod=marker:
